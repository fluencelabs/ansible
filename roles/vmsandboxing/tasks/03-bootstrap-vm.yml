- name: Download VM image
  get_url:
    url: "{{ vm_image_url }}"
    dest: "{{ vm_image_local_path }}"
    mode: '0644'
    owner: "{{ vm_libvirt_user }}"
    group: "{{ vm_libvirt_group }}"

- name: Create a new libvirt domain
  vars:
    _vm_options: "{{ vm_options + [{'host_devices': vm_host_devices}] }}"
  jm1.libvirt.domain:
    name: "{{ vm_name }}"
    hardware: "{{ _vm_options }}"

- name: Start VM
  shell: virsh start "{{ vm_name }}" || virsh reboot "{{ vm_name }}"

- name: Call HTTP service on a remote host
  command: curl -L http://{{ vm_remote_host }}/peer_id/

- name: pause for 15 seconds
  pause:
    seconds: 15
