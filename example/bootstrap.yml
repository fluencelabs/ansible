# playbook used to bootstrap network host
# runs IPFS and chain-rpc used by Nox
- hosts: network
  become: true
  tasks:
    - name: add Docker GPG key
      apt_key: url=https://download.docker.com/linux/ubuntu/gpg

    - name: add Docker APT repository
      apt_repository:
        repo: >
          deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable

    - name: install Docker CE
      apt:
        name:
          - "docker-ce"
          - "docker-ce-cli"
          - "containerd.io"
        update_cache: true
        install_recommends: false

    - name: enable docker
      service:
        name: docker
        enabled: true
        daemon_reload: true
        state: started

    - name: install python packages
      apt:
        name:
          - "python3-pip"
          - "python3-dev"
          - "python3-setuptools"
          - "virtualenv"
        install_recommends: false

    - name: install docker pip packages
      pip:
        name:
          - "docker"
          - "docker-compose"
        state: present

    - name: Start IPFS container
      docker_container:
        name: ipfs
        image: ipfs/kubo:v0.26.0
        ports:
          - "5001:5001"
          - "4001:4001"
        restart_policy: always
        state: started
        detach: true

    - name: Start Chain container
      docker_container:
        name: chain
        image: fluencelabs/chain-rpc:0.2.20
        ports:
          - "8545:8545"
        restart_policy: always
        state: started
        detach: true
